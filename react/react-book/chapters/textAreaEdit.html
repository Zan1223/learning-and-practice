<!DOCTYPE html>
<html>

<head>
  <title>propTypes</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="03.00.table.css">
</head>

<body>
  <div id="app">
    <!-- my app renders here -->
  </div>
  <script src="react/build/react.js"></script>
  <script src="react/build/react-dom.js"></script>
  <script>
    /* Text Area Example BEGIN */
    var logMixin = {
      _log: function (methodName, args) {
        console.log(this.name + "::" + methodName, args)
      },
      componentWillUpdate: function () {
        this._log('componentWillUpdate', arguments);
      },
      componentDidUpdate: function () {
        this._log('componentDidUpdate', arguments);
      },
      componentWillMount: function () {
        this._log('componentWillMount', arguments);
      },
      componentDidMount: function () {
        this._log('componentDidMount', ReactDOM.findDOMNode(this));
      },
      componentWillUnmount: function () {
        this._log('componentWillUnmount', arguments);
      }
    }

    var TextArea = React.createClass({
      name: "TextArea",
      render: function () {
        return React.DOM.textarea({
          className: "text-area",
          defaultValue: this.props.value,
          onChange: this.props.textChange
        }, null)
      }
    })

    var TextCounter = React.createClass({
      name: "Counter",
      //mixins: [logMixin],
      shouldComponentUpdate: function (nextProps, nextState) {
        return nextProps.count !== this.props.count;
      },
      render: function () {
        console.log(this.name + "::render()");
        return React.DOM.span({
            className: "text-counter"
          },
          this.props.count
        )
      }
    })

    var TextAreaCounter = React.createClass({
      name: "TextAreaCounter",
      // mixins: [logMixin],
      _textChange: function (el) {
        this.setState({
          text: el.target.value
        })
      },
      getInitialState: function () {
        return {
          text: this.props.defaultValue
        }
      },
      render: function () {
        console.log(this.name + "::render()");
        let counter = null;
        if (this.state.text.length > 0) {
          counter = React.createElement(TextCounter, {
            count: this.state.text.length
          });
        }
        return React.DOM.div(null,
          React.createElement(TextArea, {
            value: this.state.text,
            textChange: this._textChange
          }),
          counter
        )
      }
    })

    /* Text Area Example END */

    /* Table component creatation BEGIN*/
    var headers = [
      "Book", "Author", "Language", "Published", "Sales"
    ];

    var data = [
      ["The Lord of the Rings", "J. R. R. Tolkien", "English", "1954–1955", "150 million"],
      ["Le Petit Prince (The Little Prince)", "Antoine de Saint-Exupéry", "French", "1943", "140 million"],
      ["Harry Potter and the Philosopher's Stone", "J. K. Rowling", "English", "1997", "107 million"],
      ["And Then There Were None", "Agatha Christie", "English", "1939", "100 million"],
      ["Dream of the Red Chamber", "Cao Xueqin", "Chinese", "1754–1791", "100 million"],
      ["The Hobbit", "J. R. R. Tolkien", "English", "1937", "100 million"],
      ["She: A History of Adventure", "H. Rider Haggard", "English", "1887", "100 million"],
    ];

    // var Search = React.createClass({
    //   render: function(){
    //       return React.DOM.button({
    //         className: "toolbar",
    //         value: "search",
    //         onClick: this.props.search
    //       }, "Search")
    //   }
    // })

    var Excel = React.createClass({
      displayName: 'Excel',
      _preSearchData: null,
      getInitialState: function () {
        return {
          data: this.props.defaultValue,
          sortby: null,
          descending: false,
          edit: null, //{row: 0, cell: 0},
          search: false
        }
      },
      // componentWillMount: function(){
      //   console.log("props data", this.props.data)
      //   this.setState({
      //     data: this.props.data
      //   })
      // },
      _sort: function(event){
        let column = event.target.cellIndex;
        let data = this.state.data.slice();
        var descending = this.state.sortby === column && !this.state.descending;
       // console.log("descending-->", data);
        data.sort((a,b)=>{
          return descending ? (a[column] < b[column] ? 1 : -1) : (a[column] > b[column] ? 1 : -1);
        });
        this.setState({
          data: data,
          sortby: column,
          descending: descending
        })
      },
      _showEditor : function(event){
        
        this.setState({
          edit: {
            row: parseInt(event.target.dataset.row, 10),
            cell: event.target.cellIndex
          }
        })

      },
      _save: function(event){
        event.preventDefault();
        var input = event.target.firstChild;
        var data = this.state.data.slice();
        data[this.state.edit.row][this.state.edit.cell] = input.value;
        this.setState({
          edit: null,
          data: data
        })
      },
      _renderTable: function () {
       // console.log("render data", this.state.data);
        return (
          React.DOM.table(null,
              React.DOM.thead({
                onClick: this._sort
              },
              React.DOM.tr(null,
                this.props.headers.map(function(arr, index) {
                   if(this.state.sortby === index){
                     arr += this.state.descending ? ' \u2191' : ' \u2193';
                   }
                    return React.DOM.th({ key: index}, arr)
                }, this)
              )
            ),
            React.DOM.tbody({onDoubleClick: this._showEditor},
              this._renderSearch(),
              this.state.data.map((data, index) => {
                return React.DOM.tr({
                  key: index
                },
                data.map((subData, subIndex) => {
                 var content = subData;
                 var edit = this.state.edit;
                 if(edit && edit.row === index && edit.cell === subIndex){
                   content = React.DOM.form({onSubmit: this._save},
                    React.DOM.input({
                      type:"text",
                      defaultValue: subData
                    })
                   )
                 }
                return React.DOM.td({
                  key: subIndex,
                  'data-row': index
                }, content)
              })
              );
            })
            )
          )
        )
      },
      _toggleSearch: function(){
        if(this.state.search){
          this.setState({
            data: this._preSearchData,
            search: false
          })
          this._preSearchData = null;
        }else{
          this._preSearchData = this.state.data;
          this.setState({
            search: true
          });
        }
      },
      _search: function(event){
          let value = event.target.value,
              originalData = this._preSearchData.slice(),
              index = event.target.dataset["idx"];
              console.log("originalData", originalData);
          let filteredData = originalData.filter((data) => {
            if(value){
              return new RegExp(value.toLowerCase()).test(data[index].toString().toLowerCase())
            }else{
              return originalData;
            }
          });
          this.setState({
            data: filteredData
          })
      },
      _renderSearch: function(){
        if(!this.state.search){
          return;
        }
        return React.DOM.tr({onChange: this._search},
          this.props.headers.map((_ignore, idx) => {
            return React.DOM.td({key: idx},
              React.DOM.input({
                type:"text",
                "data-idx": idx
              })
            ) 
          })
        )
      },
      _renderToolbar: function(){
        return React.DOM.button({
            className: "toolbar",
            value: "search",
            onClick: this._toggleSearch
          }, (!this.state.search ? "Search" : "Done Search"))
      },
      //render both the button and table
      render: function(){
        return React.DOM.div(
          {className: "table-container"},
          this._renderToolbar(),
          this._renderTable()
        )
      }
    })

    // var Table = React.createClass({
    //   getInitialState: function () {
    //     return {
    //       isSearchActivated: false,
    //       newData: this.props.defaultValue
    //     }
    //   },
    //   _search: function(event){
    //    let oldData = this.state.newData.slice();
    //    console.log("oldData", oldData);
    //    // oldData.unshift(["input","input","input","input","input"]);
    //     this.setState({
    //       isSearchActivated: true,
    //       newData: oldData
    //     })
    //   },
    //   render: function(){
    //        console.log(this.state.isSearchActivated);
    //        console.log("newData", this.state.newData);
    //       return React.DOM.div(
    //         {
    //           className: "table-wrapper"
    //         }, 
    //         React.createElement(Search, {search: this._search}),
    //         React.createElement(Excel, {
    //           headers: this.props.headers,
    //           defaultValue: this.state.newData,
    //           isSearchActivated: this.state.isSearchActivated
    //         })
    //       )
    //   }
    // })


    // var SortBtn = React.createClass({
    //   displayName: 'SortBtn',
    //   render: function(){
    //     return (
    //       React.DOM.
    //     )
    //   }
    // })

    /* Table component creatation END*/

    ReactDOM.render(
      // React.createElement(TextAreaCounter, {
      //   defaultValue: "Hello World!"
      // }),
      React.createElement(Excel, {
        headers: headers,
        defaultValue: data
      }),
      document.getElementById("app")
    );
  </script>
</body>

</html>